# op-scim-bridge-mp Helm chart

This is a [Helm](https://helm.sh) chart for the 1Password SCIM bridge for use with Helm based deployers.
Note that this is a [wrapper chart](https://github.com/GoogleCloudPlatform/marketplace-k8s-app-tools/blob/master/docs/building-deployer-helm.md#part-1b-optional-creating-a-wrapper-chart) for deploying an existing chart to a Google Cloud Platform Kubernetes cluster. In this case we are wrapping the [1Password/op-scim-helm](https://github.com/1Password/op-scim-helm) chart.

## Chart overview

The following is the package structure:

```
op-scim-bridge-mp
├── charts
│   ├── op-scim-bridge-M.m.o.tgz
├── templates
│   ├── application.yaml
│   ├── deployer-cleanup.yaml
├── Chart.lock
├── Chart.yaml
├── logo.png
├── README.md
└── values.yaml
```

Generally the `Chart.yaml` describes the wrapper chart. For the most part we will only be updating the `appVersion` to match the version of the SCIM bridge (see [updating the SCIM bridge version](#updating-the-scim-bridge-version) below). We will on occasion also update the dependency versions. This should be limited by the fact that we are specifying a version range (ex. `~2`) instead of a complete version number (ex. `2.9.6`).

The [values.yaml](./values.yaml) provides a means of overriding default configuration values that were set in the `1Password/op-scim-bridge` chart. Consult the `values.yaml` for [1Password/op-scim-bridge](https://github.com/1Password/op-scim-helm/blob/main/charts/op-scim-bridge/values.yaml) or [bitnami/redis](https://github.com/bitnami/charts/tree/master/bitnami/redis) for details on default values and available override options.

Lastly the templates can be combined with the values to produce valid Kubernetes manifests. We have a couple of templates:

- `application.yaml` -> Overarching application description. Includes high level user facing details such as description and maintainer links and a raw logo image. This configuration also contains a list of components (`componentKinds`) that are deployed. This list is also used for cleaning up resources and should be kept up to date as the reources deployed by the chart changes.
- `deployer-cleanup.yaml` -> A `CronJob` for cleaning up stale deployer resources.

## Updating the SCIM bridge version

Updating the version of the SCIM bridge involves the following steps:

1. Confirm that the `op-scim-bridge` version of the [Chart.yaml](./Chart.yaml) is set to a range, i.e. `~2` instead of a hardcoded version such as `2.9.6`.
2. Update the chart dependencies:
   1. Update command: `helm dependency update .`, where `.` is the path to the folder where the `Chart.yaml` file is located.
   2. This should update the dependencies contained under the `charts` folder if there are new version available.
   3. It will also update the `Chart.lock` file if there are new dependency versions available. This file is automatically generated by Helm. Note that we need not commit changes to this file if the only change is the `generated` value.
3. Update the `appVersion` of the [Chart.yaml](./Chart.yaml) to match that of the bundled version of the SCIM bridge, i.e. if this release includes SCIM bridge version is "2.9.6" (build 209061), then you would update the `appVersion` to `"2.9.6"`. Note that there's no "v" preceding the `appVersion` value.
4. Commit the changes to the `./op-scim-bridge/chart` folder.
